yep—here’s a single-file index.html that works with the Mater Time Flow. It includes the full UI and the JS inlined at the bottom with FLOW_URL set to your Mater URL. Drop this in as index.html and open it—no other files required.

<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HubbTIME · HubbFISCAL</title>
  <meta name="description" content="Town of Hubbardston — Non-Union Biweekly Timesheet (HubbTIME)" />
  <style>
    :root{--bg:#0f1714;--panel:#111d18;--card:#13211b;--ink:#e7f2ec;--muted:#7aa892;--space-xs:.25rem;--space-sm:.5rem;--space-md:.75rem;--space-lg:1rem;--space-xl:1.5rem;--space-2xl:2rem;--space-3xl:3rem;--radius:8px;--ring:0 0 0 2px rgba(127,199,155,.35)}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:#a0e3bd;text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1100px;margin:0 auto;padding:var(--space-2xl) var(--space-lg)}
    .site-header{display:flex;gap:var(--space-lg);align-items:center;padding:var(--space-lg);border-bottom:1px solid #1f2c27}
    .brand{display:flex;align-items:center;gap:var(--space-md)}
    .seal{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:#1a2a23;color:#a7e0bf;font-weight:700}
    .tagline{margin:.15rem 0 0;color:var(--muted);font-size:.9rem}
    .main-nav .nav-toggle{display:none}
    .main-nav ul{display:flex;gap:.75rem;margin:0;padding:0;list-style:none}
    .main-nav a{display:block;padding:.35rem .6rem;border-radius:6px;color:var(--ink)}
    .main-nav a.active,.main-nav a:hover{background:#173127}
    .btn{border:0;border-radius:8px;padding:.55rem .8rem;cursor:pointer}
    .btn.primary{background:#2c7a52;color:white}
    .btn.secondary{background:#20382e;color:#d7efe4}
    .btn.ghost{background:transparent;color:#cfe9db;border:1px solid #2b463b}
    .btn.danger{background:#6a2c2c;color:#fff}
    .card{background:var(--card);border:1px solid #1a2a23;border-radius:var(--radius);margin:var(--space-xl) 0}
    .card-header{padding:var(--space-lg) var(--space-lg) var(--space-sm);border-bottom:1px solid #1f2c27}
    .card-title{margin:0}
    .form-group{padding:var(--space-lg)}
    .input,.tableWrap input,.tableWrap select{background:#0f1915;color:var(--ink);border:1px solid #254235;border-radius:8px;padding:.5rem .6rem}
    .tableWrap{overflow:auto;border-top:1px solid #1f2c27}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2c27;padding:.6rem .5rem;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#102019;z-index:1}
    .quick-actions{display:flex;flex-wrap:wrap;gap:.5rem;padding:var(--space-lg)}
    .totals-panel{padding:var(--space-lg);border-top:1px solid #1f2c27}
    .totals-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:var(--space-md);padding:0 var(--space-lg) var(--space-lg)}
    .total-item{background:#0f1915;border:1px solid #1f2c27;border-radius:8px;padding:.6rem}
    .total-label{color:var(--muted);font-size:.85rem}
    .total-value{font-weight:700;margin-top:.25rem}
    .alert{margin:var(--space-lg);padding:.8rem 1rem;border-radius:8px}
    .alert.info{background:#0c2018;border:1px solid #1f3628}
    .alert.success{background:#0f241a;border:1px solid #1a5137}
    .alert.error{background:#221214;border:1px solid #5a2a2a}
    .text-center{text-align:center}
    .text-muted{color:var(--muted)}
    .mt-md{margin-top:var(--space-md)}
    .status-indicator{background:#0e1b16;border:1px solid #214737;border-radius:999px;padding:.25rem .6rem;display:inline-flex;gap:.5rem;align-items:center}
    .loading-spinner{width:14px;height:14px;border-radius:50%;border:2px solid #335e4a;border-right-color:transparent;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width: 800px){.totals-grid{grid-template-columns:repeat(2,1fr)} .main-nav ul{flex-wrap:wrap}}
  </style>
</head>
<body>
  <a class="skip-link sr-only" href="#main">Skip to content</a>

  <header class="site-header">
    <div class="brand">
      <div class="seal" aria-hidden="true">H</div>
      <div class="brand-text">
        <h1 class="site-title">HubbFISCAL</h1>
        <p class="tagline">Town of Hubbardston · Budget & Financial Management Hub</p>
      </div>
    </div>
    <nav class="main-nav" aria-label="Primary" aria-expanded="false">
      <button class="nav-toggle" aria-expanded="false" aria-controls="navList">Menu</button>
      <ul id="navList">
        <li><a href="#" class="active">HubbTIME</a></li>
      </ul>
    </nav>
    <div style="margin-left: auto;">
      <button id="themeToggle" class="btn ghost" aria-pressed="false">Light</button>
    </div>
  </header>

  <main id="main" class="container">
    <div id="hubbtimeContainer">
      <header class="page-header">
        <h1>Town of Hubbardston — Enhanced Biweekly Timesheet</h1>
        <p>Smart timesheet system with automated calculations and municipal GL integration</p>
      </header>

      <form id="timesheetForm">
        <div id="systemMsg" class="alert info" role="status" aria-live="polite" style="display:none;"></div>

        <!-- Employee -->
        <section class="card">
          <div class="card-header"><h2 class="card-title">Employee Information</h2></div>
          <div class="form-group">
            <label class="label" for="employeeSearch">Employee (search by name)</label>
            <div style="display:flex; gap:var(--space-sm); align-items:center;">
              <input id="employeeSearch" list="employeeList" placeholder="Start typing a name..." autocomplete="off" class="input">
              <button type="button" class="btn secondary" id="clearEmployeeBtn">Clear</button>
            </div>
            <datalist id="employeeList"></datalist>
            <input type="hidden" id="employeeIndex" value="">
          </div>
          <div class="employee-info" id="employeeDetails" style="display:none;">
            <div class="totals-grid">
              <div class="total-item"><div class="total-label">Department</div><div class="total-value" id="department">—</div></div>
              <div class="total-item"><div class="total-label">Pay Type</div><div class="total-value" id="payType">—</div></div>
              <div class="total-item"><div class="total-label">Rate / Salary</div><div class="total-value" id="rate">—</div></div>
            </div>
          </div>
        </section>

        <!-- Pay period -->
        <section class="card">
          <div class="card-header"><h2 class="card-title">Pay Period</h2></div>
          <div class="form-group">
            <label class="label" for="warrant">Select Pay Period</label>
            <select id="warrant" class="input"><option value="">Select Pay Period...</option></select>
          </div>
        </section>

        <!-- Entries -->
        <section class="card">
          <div class="card-header"><h2 class="card-title">Time Entries</h2></div>
          <div class="quick-actions">
            <button type="button" class="btn primary" id="addRowBtn">Add Row</button>
            <button type="button" class="btn secondary" id="townHallBtn">Town Hall Hours</button>
            <button type="button" class="btn secondary" id="splitShiftBtn">Split Shift</button>
            <button type="button" class="btn secondary" id="overtimeBtn">Overtime Day</button>
            <button type="button" class="btn secondary" id="sickBtn">Sick Day</button>
            <button type="button" class="btn secondary" id="personalBtn">Personal Day</button>
            <button type="button" class="btn secondary" id="vacationBtn">Vacation Day</button>
            <button type="button" class="btn secondary" id="holidayBtn">Holiday</button>
            <button type="button" class="btn danger" id="clearAllBtn">Clear All</button>
          </div>
          <div class="table-container">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th><th>Start Time</th><th>End Time</th><th>Hours</th>
                    <th>Type</th><th>GL Code</th><th>Description</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="timeBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Summary -->
        <section class="card">
          <div class="card-header"><h2 class="card-title">Summary</h2></div>
          <div class="totals-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-md);">
              <div><div class="total-label">Total Hours This Period</div><div id="totalHours" class="total-value">0.00</div></div>
              <div style="text-align:right;"><div class="total-label">Estimated Gross Pay</div><div id="grossPay" class="total-value">$0.00</div></div>
            </div>
          </div>
          <div class="totals-grid">
            <div class="total-item"><div class="total-label">Regular</div><div class="total-value" id="sumRegular">0.00</div></div>
            <div class="total-item"><div class="total-label">Sick</div><div class="total-value" id="sumSick">0.00</div></div>
            <div class="total-item"><div class="total-label">Personal</div><div class="total-value" id="sumPersonal">0.00</div></div>
            <div class="total-item"><div class="total-label">Vacation</div><div class="total-value" id="sumVacation">0.00</div></div>
            <div class="total-item"><div class="total-label">Holiday</div><div class="total-value" id="sumHoliday">0.00</div></div>
          </div>
        </section>

        <!-- GL Review -->
        <section class="card">
          <div class="card-header"><h2 class="card-title">GL Review — Hours & Cost Allocation</h2></div>
          <div id="glReviewWrap" class="table-container">
            <p class="text-center text-muted" style="padding:var(--space-xl);">Enter time entries above to see GL code breakdown and cost allocation</p>
          </div>
          <div class="alert info">
            <strong>Smart Allocation:</strong> Hourly employees: Regular hours automatically convert to overtime (1.5x) when weekly total exceeds 40 hours. Salary: biweekly salary split proportionally across GL codes.
          </div>
        </section>

        <!-- Submit -->
        <section class="card text-center">
          <div class="alert info" role="note" aria-label="Compliance Notice" style="margin-bottom:var(--space-md); text-align:left;">
            <p><strong>Compliance Notice:</strong></p>
            <p>By selecting "Submit Timesheet," you attest that the information provided is accurate and complete. Your submission constitutes your electronic signature under applicable MGL statutes.</p>
          </div>
          <button type="submit" class="btn primary" id="submitBtn" style="padding:var(--space-md) var(--space-xl); font-size:1.1rem;">Submit Timesheet</button>
          <div id="submitStatus" class="mt-md"></div>
        </section>
      </form>
    </div>
  </main>

  <footer class="site-footer text-center" style="margin-top:var(--space-3xl); padding:var(--space-lg); color:var(--muted);">
    <p>&copy; 2025 Town of Hubbardston, MA · <a href="mailto:admin@hubbardstonma.gov">admin@hubbardstonma.gov</a></p>
  </footer>

  <div class="status-indicator saving" id="autoSaveIndicator" style="position:fixed; top:var(--space-md); right:var(--space-md); opacity:0; transition:opacity .3s; z-index:1000;" aria-live="polite">
    <div class="loading-spinner"></div> Auto-saved
  </div>

  <!-- ==================== APP SCRIPT (INLINE) ==================== -->
  <script>
  /* =========================================================
     HubbFISCAL · Global site scripts
     ========================================================= */
  (function () {
    'use strict';
    const nav = document.querySelector('.main-nav');
    const toggle = document.querySelector('.nav-toggle');
    if (toggle && nav) {
      toggle.addEventListener('click', () => {
        const expanded = nav.getAttribute('aria-expanded') === 'true';
        nav.setAttribute('aria-expanded', String(!expanded));
        toggle.setAttribute('aria-expanded', String(!expanded));
      });
    }
    try {
      const here = location.pathname.split('/').filter(Boolean).pop() || 'index.html';
      document.querySelectorAll('.main-nav a').forEach(a => {
        const hrefLast = (a.getAttribute('href') || '').split('/').filter(Boolean).pop();
        if (hrefLast === here || a.classList.contains('active')) a.classList.add('active');
      });
    } catch (e) {}
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      const KEY='hubbfiscal-theme', root=document.documentElement;
      const apply = mode => {
        root.dataset.theme = mode;
        themeToggle.setAttribute('aria-pressed', String(mode === 'light'));
        themeToggle.textContent = mode === 'light' ? 'Dark' : 'Light';
        if (mode === 'light') {
          root.style.setProperty('--bg','#f5faf7');root.style.setProperty('--panel','#ffffff');root.style.setProperty('--card','#ffffff');
          root.style.setProperty('--ink','#14271e');root.style.setProperty('--muted','#476457');
        } else {
          root.style.removeProperty('--bg');root.style.removeProperty('--panel');root.style.removeProperty('--card');
          root.style.removeProperty('--ink');root.style.removeProperty('--muted');
        }
        localStorage.setItem(KEY, mode);
      };
      const saved = localStorage.getItem(KEY);
      apply(saved === 'light' ? 'light' : 'dark');
      themeToggle.addEventListener('click',()=>apply(root.dataset.theme==='light'?'dark':'light'));
    }
  })();

  /* =========================================================
     HubbTIME Module (inline, Mater Time Flow URL)
     ========================================================= */
  window.HubbTIME = (function () {
    'use strict';
    const container = document.getElementById('hubbtimeContainer');
    const api = {}; if (!container) return api;

    // ---------- CONFIG (Mater Time Flow URL) ----------
    const FLOW_URL = "https://prod-30.usgovtexas.logic.azure.us:443/workflows/186e14fa253247f4914e6fb4ad7344b9/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=bi0QTrd3oZwnQKtHahv4p4rftv7mCvQw265EdjMvdfw";
    const NOTIFY = ["admin@hubbardstonma.gov", "accountant@hubbardstonma.gov"];

    // ---------- STATE ----------
    let currentEmployee = null;
    let currentWarrant = null;

    // ---------- UTILS ----------
    const $ = s => document.querySelector(s);
    const currency = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(n||0));
    const setMsg = (text,type,show) => {
      const el = $('#systemMsg'); if (!el) return;
      if (!show){el.style.display='none';return;}
      el.className = 'alert ' + (type||'info'); el.textContent = text; el.style.display='block';
    };
    const timeDiffHours = (start,end) => {
      if (!start||!end) return 0;
      const [sh,sm]=start.split(':').map(Number),[eh,em]=end.split(':').map(Number);
      let s=sh*60+sm,e=eh*60+em; if (e<s) e+=24*60; return Math.round(((e-s)/60)*100)/100;
    };
    const getWeekIndex = (dateStr) => {
      if (!currentWarrant||!dateStr) return 1;
      const start=new Date(currentWarrant.start+'T00:00:00'), d=new Date(dateStr+'T00:00:00');
      const diffDays=Math.floor((d-start)/86400000); return diffDays<7?1:2;
    };
    const hhmmToMin = hhmm => { if(!hhmm) return null; const [h,m]=hhmm.split(':').map(Number); return h*60+m; };
    const minToHHMM = mins => `${String(Math.floor(mins/60)).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`;

    // ---------- DATA (trimmed to keep page light; add the rest as needed) ----------
    const EMPLOYEES = [
      {"name":"PATRICIA LOWE","department":"Select Board","payType":"hourly","rate":23.38,"isAdmin":true,"position":"Executive Assistant / Cable Clerk"},
      {"name":"LEEANN E MOSES","department":"Assessors/Land Use","payType":"hourly","rate":23.38,"isAdmin":true,"position":"Administrative Services Coordinator"},
      {"name":"NATHAN BOUDREAU","department":"Administration","payType":"salary","rate":115000,"isAdmin":true,"position":"Town Administrator"}
      // ⟵ add full roster here if you want (works fine with any subset)
    ];

    const WARRANTS = [
      { number: 6, start: "2025-09-07", end: "2025-09-20", due: "2025-09-22", check: "2025-09-25" },
      { number: 7, start: "2025-09-21", end: "2025-10-04", due: "2025-10-06", check: "2025-10-09" }
    ];

    const DEPT_GLS = {
      "Select Board":"1000-122-5100-0000","Assessors/Land Use":"1000-141-5100-0000","Land Use":"1000-241-5100-0000",
      "Administration":"1000-129-5100-0000","Treasurer/Collector":"1000-149-5100-0000","Public Works":"1000-420-5100-0000",
      "Police":"1000-210-5100-0000","Fire":"1000-220-5100-0000","Library":"1000-610-5100-0000","Senior Center / COA":"1000-541-5100-0000"
    };
    const POSITION_GLS = {
      "Executive Assistant / Cable Clerk":"1000-122-5100-0000",
      "Administrative Services Coordinator":"1000-141-5100-0000",
      "Town Administrator":"1000-129-5100-0000"
    };
    const EMPLOYEE_GLS = {};
    const EMPLOYEE_POSITIONS = {
      "PATRICIA LOWE":[
        { title:"Executive Assistant (Select Board)", gl:"1000-122-5100-0000", rate:23.38, proportion:26 },
        { title:"Library Assistant", gl:"1000-610-5100-0000", rate:17.57, proportion:10 }
      ],
      "LEEANN E MOSES":[
        { title:"Land Use Administrative", gl:"1000-241-5100-0000", proportion:37 },
        { title:"Assessor Administrative", gl:"1000-141-5100-0000", proportion:31 }
      ]
    };
    const AUTO_SPLITS = {
      "PATRICIA LOWE":{ mode:"weekly", targets:[{gl:"1000-610-5100-0000",hours:8,label:"Library"},{gl:"1000-122-5100-0000",hours:26,label:"Select Board"}]},
      "LEEANN E MOSES":{ mode:"biweekly", targets:[{gl:"1000-241-5100-0000",hours:37,label:"Land Use"},{gl:"1000-141-5100-0000",hours:31,label:"Assessors"}]}
    };

    // ---------- GL helpers ----------
    function getEmployeeGLChoices(emp){
      if(!emp) return [];
      const choices=(EMPLOYEE_POSITIONS[emp.name]||[]).map(x=>({label:`${x.title} — ${x.gl}`, value:x.gl}));
      const empGL=EMPLOYEE_GLS[emp.name]; if(empGL) choices.push({label:`Employee-specific — ${empGL}`,value:empGL});
      if(emp.position && POSITION_GLS[emp.position]){ const gl=POSITION_GLS[emp.position]; if(!choices.some(c=>c.value===gl)) choices.push({label:`Position (${emp.position}) — ${gl}`,value:gl});}
      const deptGL=DEPT_GLS[emp.department]; if(deptGL && !choices.some(c=>c.value===deptGL)) choices.push({label:`Department (${emp.department}) — ${deptGL}`,value:deptGL});
      const seen=new Set(); return choices.filter(c=>seen.has(c.value)?false:seen.add(c.value));
    }
    function getDefaultGL(emp){
      if(!emp) return "";
      if(EMPLOYEE_GLS[emp.name]) return EMPLOYEE_GLS[emp.name];
      if(emp.position && POSITION_GLS[emp.position]) return POSITION_GLS[emp.position];
      if(DEPT_GLS[emp.department]) return DEPT_GLS[emp.department];
      return "";
    }
    function rebuildGLDatalistFor(emp){
      let dl=document.getElementById('glList'); if(!dl){ dl=document.createElement('datalist'); dl.id='glList'; document.body.appendChild(dl);}
      dl.innerHTML='';
      if(emp){ getEmployeeGLChoices(emp).forEach(choice=>{ const o=document.createElement('option'); o.value=choice.value; o.label=choice.label; dl.appendChild(o);}); }
    }
    function createGLInput(initialGL='',emp=null){
      const hasMulti=emp && EMPLOYEE_POSITIONS[emp.name] && EMPLOYEE_POSITIONS[emp.name].length;
      const glDiv=document.createElement('div'); glDiv.className='gl-cell';
      const glInput=document.createElement('input'); glInput.type='text'; glInput.setAttribute('list','glList'); glInput.className='gl-input input';
      glInput.placeholder='Type GL code or search...'; glInput.value=initialGL||getDefaultGL(emp); glInput.style.minWidth='15ch'; glInput.autocomplete='off';
      glDiv.appendChild(glInput);
      if(hasMulti){
        const glChooser=document.createElement('select'); glChooser.className='gl-chooser input'; glChooser.style.marginTop='4px'; glChooser.style.fontSize='12px';
        const def=document.createElement('option'); def.value=''; def.textContent='↓ Quick select role'; glChooser.appendChild(def);
        EMPLOYEE_POSITIONS[emp.name].forEach(p=>{ const o=document.createElement('option'); o.value=p.gl; const r=p.rate?` @ $${p.rate}/hr`:''; const pr=p.proportion?` (${p.proportion} parts)`:''; o.textContent=`${p.title}${r}${pr}`; glChooser.appendChild(o); });
        glChooser.addEventListener('change',function(){ if(this.value){ glInput.value=this.value; glInput.dispatchEvent(new Event('input',{bubbles:true})); }});
        glDiv.appendChild(glChooser);
      }
      return glDiv;
    }
    function reseedBlankGLs(){
      const rows=[...document.querySelectorAll('#timeBody tr')]; const def=getDefaultGL(currentEmployee);
      rows.forEach(r=>{ const glIn=r.querySelector('.gl-input'); if(glIn && !glIn.value && def) glIn.value=def; });
    }

    // ---------- DOM init ----------
    window.addEventListener('DOMContentLoaded',()=>{
      const dl=$('#employeeList'); if(dl){ dl.innerHTML=''; EMPLOYEES.forEach((emp,i)=>{ const o=document.createElement('option'); o.value=emp.name; o.setAttribute('data-index',String(i)); dl.appendChild(o);}); }
      const wsel=$('#warrant'); if(wsel){ wsel.innerHTML='<option value=\"\">Select Pay Period…</option>'; WARRANTS.forEach((w,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=`Warrant #${w.number} — ${w.start} to ${w.end} — Due ${w.due}`; wsel.appendChild(o);}); }
      const es=$('#employeeSearch'); if(es) es.addEventListener('input',handleEmployee);
      const ceb=$('#clearEmployeeBtn'); if(ceb) ceb.addEventListener('click',()=>{ clearEmployee(); const details=$('#employeeDetails'); if(details) details.style.display='none'; });
      if(wsel) wsel.addEventListener('change',handleWarrant);
      const add=$('#addRowBtn'); if(add) add.addEventListener('click',()=>addTimeRow());
      const clr=$('#clearAllBtn'); if(clr) clr.addEventListener('click',clearAllRows);
      const th=$('#townHallBtn'); if(th) th.addEventListener('click',addTownHallHours);
      const split=$('#splitShiftBtn'); if(split) split.addEventListener('click',addSplitShift);
      const ot=$('#overtimeBtn'); if(ot) ot.addEventListener('click',addOvertimeDay);
      const sick=$('#sickBtn'); if(sick) sick.addEventListener('click',addSickDay);
      const vac=$('#vacationBtn'); if(vac) vac.addEventListener('click',addVacationDay);
      const pers=$('#personalBtn'); if(pers) pers.addEventListener('click',()=>addQuickDay('Personal','Personal Day','8.00'));
      const hol=$('#holidayBtn'); if(hol) hol.addEventListener('click',()=>addQuickDay('Holiday','Holiday','8.00'));
      const form=$('#timesheetForm'); if(form) form.addEventListener('submit',handleSubmit);
      document.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter' && ev.target?.matches && ev.target.matches('#timeBody input, #timeBody select')){ ev.preventDefault(); const fields=[...document.querySelectorAll('#timeBody input, #timeBody select')]; const idx=fields.indexOf(ev.target); if(idx>=0 && idx<fields.length-1) fields[idx+1].focus(); }});
      calculateTotals();
      setMsg("System loaded successfully. Select an employee to begin.","info",true);
    });

    // ---------- Handlers ----------
    function handleEmployee(e){
      const name=(e.target.value||'').trim();
      const emp=EMPLOYEES.find(x=>x.name.toLowerCase()===name.toLowerCase());
      if(!emp) return; currentEmployee=emp;
      const details=document.getElementById('employeeDetails'); if(details) details.style.display='block';
      const dep=$('#department'); if(dep) dep.textContent=emp.department||'—';
      const pty=$('#payType'); if(pty) pty.textContent=emp.payType? (emp.payType[0].toUpperCase()+emp.payType.slice(1)):'—';
      const rate=$('#rate'); if(rate) rate.textContent=emp.payType==='salary' ? (emp.rate? (currency(emp.rate)+' annually'):'—') : (emp.rate? (currency(emp.rate)+' per hour'):'—');
      rebuildGLDatalistFor(emp); reseedBlankGLs(); calculateTotals();
      if(EMPLOYEE_POSITIONS[emp.name]){
        const positions=EMPLOYEE_POSITIONS[emp.name]; const positionText=positions.map(p=>`${p.title}${p.proportion?` (${p.proportion} parts)`:''}`).join(' & ');
        setMsg(`${emp.name} has multiple positions: ${positionText}. Quick day buttons will auto-split hours.`,'info',true);
      }
    }
    function clearEmployee(){
      currentEmployee=null; ['employeeIndex','employeeSearch'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      ['department','payType','rate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent='—'; });
      const dl=document.getElementById('glList'); if(dl) dl.innerHTML=''; calculateTotals();
    }
    function handleWarrant(e){ const idx=e.target.value; currentWarrant=(idx==='')?null:WARRANTS[Number(idx)]; calculateTotals(); }

    // ---------- Rows ----------
    function addTimeRow(){ const seedGL=getDefaultGL(currentEmployee); addTimeRowWith('','','','', 'Regular', seedGL, ''); }
    function addTimeRowWith(date,start,end,hours,type,glCode,description){
      const tbody=$('#timeBody'); if(!tbody) return;
      const tr=document.createElement('tr');
      tr.innerHTML =
      `<td><input type="date" class="date-cell input" value="${date||''}"></td>
       <td><input type="time" class="time-start input" value="${start||''}"></td>
       <td><input type="time" class="time-end input" value="${end||''}"></td>
       <td><input type="number" step="0.25" min="0" placeholder="0.00" class="time-hours input" value="${hours||''}"></td>
       <td><select class="time-type input">
            <option${type==='Regular'?' selected':''}>Regular</option>
            <option${type==='Sick'?' selected':''}>Sick</option>
            <option${type==='Personal'?' selected':''}>Personal</option>
            <option${type==='Vacation'?' selected':''}>Vacation</option>
            <option${type==='Holiday'?' selected':''}>Holiday</option>
          </select></td>
       <td></td>
       <td><input type="text" class="input" placeholder="Describe work or leave" value="${description||''}"></td>
       <td><div style="display:flex; gap:4px; flex-wrap:wrap;">
            <button type="button" class="btn secondary insert-above" style="font-size:12px; padding:2px 6px;">↑ Above</button>
            <button type="button" class="btn secondary insert-below" style="font-size:12px; padding:2px 6px;">↓ Below</button>
            <button type="button" class="btn danger remove-row" style="font-size:12px; padding:2px 6px;">Remove</button>
          </div></td>`;
      const glCell=tr.children[5]; const glInput=createGLInput(glCode||getDefaultGL(currentEmployee),currentEmployee); glCell.appendChild(glInput);
      tbody.appendChild(tr);
      if(start && end && type==='Regular'){ tr.querySelector('.time-hours').value=timeDiffHours(start,end).toFixed(2); }
      wireRowEvents(tr); return tr;
    }
    function wireRowEvents(tr){
      tr.querySelector('.remove-row').addEventListener('click',()=>{ tr.remove(); calculateTotals(); });
      tr.querySelector('.insert-above').addEventListener('click',()=>cloneRow(tr,'above'));
      tr.querySelector('.insert-below').addEventListener('click',()=>cloneRow(tr,'below'));
      tr.querySelectorAll('input, select').forEach(inp=>{
        inp.addEventListener('input',function(){
          const rowType=tr.querySelector('.time-type')?.value||'Regular';
          if((this.classList.contains('time-start')||this.classList.contains('time-end')) && rowType==='Regular'){
            const s=tr.querySelector('.time-start')?.value||'', e=tr.querySelector('.time-end')?.value||'';
            if(s&&e) tr.querySelector('.time-hours').value=timeDiffHours(s,e).toFixed(2);
          }
          calculateTotals();
        });
      });
    }
    function cloneRow(tr,where){
      const newRow=document.createElement('tr'); newRow.innerHTML=tr.innerHTML;
      newRow.querySelectorAll('input').forEach(input=>{
        if(input.type==='date'){ input.value=tr.querySelector('.date-cell').value; }
        else if(input.classList.contains('gl-input')){ input.value=tr.querySelector('.gl-input').value; }
        else{ input.value=''; }
      });
      newRow.querySelectorAll('select').forEach(select=>{
        if(select.classList.contains('time-type')){ select.value=tr.querySelector('.time-type').value; } else { select.selectedIndex=0; }
      });
      const glCell=newRow.children[5]; glCell.innerHTML=''; const glInput=createGLInput(tr.querySelector('.gl-input').value,currentEmployee); glCell.appendChild(glInput);
      if(where==='above') tr.parentNode.insertBefore(newRow,tr); else tr.parentNode.insertBefore(newRow,tr.nextSibling);
      wireRowEvents(newRow); calculateTotals();
    }
    function clearAllRows(){ const tb=$('#timeBody'); if(tb) tb.innerHTML=''; calculateTotals(); }

    // ---------- Supplemental ----------
    function addSplitShift(){
      const tbody=document.getElementById('timeBody'); if(!tbody||!tbody.children.length){ setMsg('Add a time entry first before splitting shifts.','error',true); return; }
      const lastRow=tbody.children[tbody.children.length-1];
      const date=lastRow.querySelector('.date-cell')?.value,start=lastRow.querySelector('.time-start')?.value,end=lastRow.querySelector('.time-end')?.value;
      const gl=lastRow.querySelector('.gl-input')?.value||getDefaultGL(currentEmployee);
      const type=lastRow.querySelector('.time-type')?.value||'Regular'; const desc=lastRow.children[6]?.querySelector('input')?.value||'';
      if(!date||!start||!end){ setMsg('Complete date, start, and end first.','error',true); return; }
      if(type!=='Regular'){ setMsg('Split Shift only works with Regular entries.','error',true); return; }
      const s=hhmmToMin(start), e=hhmmToMin(end); if(s==null||e==null||e<=s){ setMsg('Invalid time range.','error',true); return; }
      const mid=minToHHMM(Math.floor((s+e)/2)); lastRow.remove();
      addTimeRowWith(date,start,mid,'','Regular',gl,`${desc} (Split 1/2)`.trim());
      addTimeRowWith(date,mid,end,'','Regular',gl,`${desc} (Split 2/2)`.trim());
      calculateTotals(); setMsg(`Shift split: ${start}-${mid} and ${mid}-${end}`,'success',true);
    }
    function addQuickDay(kind,label,defaultHours='8.00'){
      if(!currentEmployee){ setMsg('Please select an employee first.','error',true); return; }
      const today=new Date().toISOString().slice(0,10);
      if(EMPLOYEE_POSITIONS[currentEmployee.name]){
        const positions=EMPLOYEE_POSITIONS[currentEmployee.name], totalParts=positions.reduce((s,p)=>s+p.proportion,0), totalHours=parseFloat(defaultHours);
        positions.forEach(p=>{ const h=(totalHours*p.proportion/totalParts).toFixed(2); addTimeRowWith(today,'','',h,kind,p.gl,`${label} (${p.title})`); });
        calculateTotals(); setMsg(`${label} split across roles.`,'success',true);
      } else {
        addTimeRowWith(today,'','',defaultHours,kind,getDefaultGL(currentEmployee),label);
        calculateTotals(); setMsg(`${label} added.`,'success',true);
      }
    }
    const addOvertimeDay=()=>addQuickDay('Regular','Overtime Day','10.00');
    const addSickDay=()=>addQuickDay('Sick','Sick Day','8.00');
    const addVacationDay=()=>addQuickDay('Vacation','Vacation Day','8.00');

    function allocateHoursToTargets(rows,targets){
      if(!rows.length||!targets.length) return;
      let idx=0, remaining=targets[idx].hours; const tbody=document.getElementById('timeBody');
      for(let i=0;i<rows.length;i++){
        const row=rows[i], hoursInput=row.querySelector('.time-hours'), rowHours=parseFloat(hoursInput?.value||0);
        if(rowHours<=0) continue; if(idx>=targets.length) continue; const tgt=targets[idx];
        if(rowHours<=remaining){
          const glInput=row.querySelector('.gl-input'); if(glInput) glInput.value=tgt.gl;
          remaining-=rowHours; if(remaining<=.01){ idx++; if(idx<targets.length) remaining=targets[idx].hours; }
        } else {
          const date=row.querySelector('.date-cell')?.value||'', type=row.querySelector('.time-type')?.value||'Regular', desc=row.children[6]?.querySelector('input')?.value||'';
          const glInput=row.querySelector('.gl-input'); if(glInput) glInput.value=tgt.gl; hoursInput.value=remaining.toFixed(2);
          const startInput=row.querySelector('.time-start'), endInput=row.querySelector('.time-end'); if(startInput) startInput.value=''; if(endInput) endInput.value='';
          const leftover=rowHours-remaining; idx++;
          if(idx<targets.length){
            const next=targets[idx]; const newRow=addTimeRowWith(date,'','',leftover.toFixed(2),type,next.gl,desc);
            if(row.nextSibling) tbody.insertBefore(newRow,row.nextSibling); else tbody.appendChild(newRow);
            remaining=targets[idx].hours-leftover; if(remaining<=.01){ idx++; if(idx<targets.length) remaining=targets[idx].hours; }
          } else {
            const def=getDefaultGL(currentEmployee); const newRow=addTimeRowWith(date,'','',leftover.toFixed(2),type,def,desc);
            if(row.nextSibling) tbody.insertBefore(newRow,row.nextSibling); else tbody.appendChild(newRow);
          }
        }
      }
    }
    function addTownHallHours(){
      if(!currentWarrant){ setMsg("Select a pay period first.","info",true); return; }
      clearAllRows();
      const start=new Date(currentWarrant.start+'T00:00:00'), end=new Date(currentWarrant.end+'T00:00:00');
      const schedule={1:{start:"08:00",end:"16:00"},2:{start:"08:00",end:"18:00"},3:{start:"08:00",end:"16:00"},4:{start:"08:00",end:"16:00"}};
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const dow=d.getDay(); if(schedule[dow]){
          const iso=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          addTimeRowWith(iso,schedule[dow].start,schedule[dow].end,'','Regular',getDefaultGL(currentEmployee),'Town Hall hours');
        }
      }
      calculateTotals(); setMsg(`Town Hall hours template applied for ${currentWarrant.start} to ${currentWarrant.end}.`,"success",true);
      if(currentEmployee && AUTO_SPLITS[currentEmployee.name]){
        const cfg=AUTO_SPLITS[currentEmployee.name];
        const allRows=[...document.querySelectorAll('#timeBody tr')];
        const regularRows=allRows.filter(r=>(r.querySelector('.time-type')?.value||'Regular')==='Regular');
        if(cfg.mode==="weekly"){
          const week1=regularRows.filter(r=>getWeekIndex(r.querySelector('.date-cell')?.value||'')===1);
          const week2=regularRows.filter(r=>getWeekIndex(r.querySelector('.date-cell')?.value||'')===2);
          allocateHoursToTargets(week1,cfg.targets); allocateHoursToTargets(week2,cfg.targets);
        }else{ allocateHoursToTargets(regularRows,cfg.targets); }
        calculateTotals();
      }
    }

    // ---------- GL Review & Totals ----------
    function updateGLReview(){
      const glBreakdown={};
      [...document.querySelectorAll('#timeBody tr')].forEach(row=>{
        const hours=parseFloat(row.querySelector('.time-hours')?.value||0)||0;
        const type=row.querySelector('.time-type')?.value||'Regular';
        const gl=row.querySelector('.gl-input')?.value||'';
        if(hours>0 && gl){
          if(!glBreakdown[gl]) glBreakdown[gl]={regular:0,sick:0,personal:0,vacation:0,holiday:0,total:0};
          glBreakdown[gl][type.toLowerCase()]+=hours; glBreakdown[gl].total+=hours;
        }
      });
      const wrap=$('#glReviewWrap'); if(!wrap) return;
      if(Object.keys(glBreakdown).length===0){ wrap.innerHTML=`<p class="text-center text-muted" style="padding:var(--space-xl);">Enter time entries above to see GL code breakdown and cost allocation</p>`; return; }
      let tableHTML=`<div class="tableWrap"><table><thead><tr>
          <th>GL Code</th><th>Regular</th><th>Sick</th><th>Personal</th><th>Vacation</th><th>Holiday</th><th>Total Hours</th><th>Est. Cost</th>
        </tr></thead><tbody>`;
      Object.entries(glBreakdown).forEach(([gl,b])=>{
        const rate=(currentEmployee && currentEmployee.rate)||0;
        const totalCost=(b.total*rate);
        tableHTML+=`<tr>
          <td><strong>${gl}</strong></td>
          <td>${b.regular.toFixed(2)}</td><td>${b.sick.toFixed(2)}</td><td>${b.personal.toFixed(2)}</td>
          <td>${b.vacation.toFixed(2)}</td><td>${b.holiday.toFixed(2)}</td><td><strong>${b.total.toFixed(2)}</strong></td>
          <td><strong>${currency(totalCost)}</strong></td>
        </tr>`;
      });
      tableHTML+=`</tbody></table></div>`; wrap.innerHTML=tableHTML;
    }
    function calculateTotals(){
      let total=0, reg=0, sick=0, pers=0, vac=0, hol=0, w1Reg=0, w2Reg=0;
      const rows=[...document.querySelectorAll('#timeBody tr')];
      rows.forEach(row=>{
        const date=row.querySelector('.date-cell')?.value||'';
        const hours=parseFloat(row.querySelector('.time-hours')?.value||0)||0;
        const type=row.querySelector('.time-type')?.value||'Regular'; if(!hours) return;
        total+=hours;
        if(type==='Regular'){ reg+=hours; const wk=getWeekIndex(date); if(wk===1) w1Reg+=hours; else w2Reg+=hours; }
        else if(type==='Sick') sick+=hours; else if(type==='Personal') pers+=hours; else if(type==='Vacation') vac+=hours; else if(type==='Holiday') hol+=hours;
      });
      let overtime=0, regPayable=reg;
      if(currentEmployee && currentEmployee.payType==='hourly'){
        const w1OT=Math.max(0,w1Reg-40), w2OT=Math.max(0,w2Reg-40); overtime=w1OT+w2OT; regPayable=Math.max(0,reg-overtime);
      }
      const setTxt=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=(+v).toFixed(2); };
      setTxt('totalHours',total); setTxt('sumRegular',regPayable); setTxt('sumSick',sick); setTxt('sumPersonal',pers); setTxt('sumVacation',vac); setTxt('sumHoliday',hol);
      let gross=0; if(currentEmployee && currentEmployee.rate){ if(currentEmployee.payType==='hourly'){ const r=currentEmployee.rate; gross = regPayable*r + overtime*r*1.5 + (sick+pers+vac+hol)*r; } else { gross=currentEmployee.rate/26; } }
      const gp=document.getElementById('grossPay'); if(gp) gp.textContent=currency(gross);
      updateGLReview();
    }

    // ---------- Submit ----------
    async function handleSubmit(e){
      e.preventDefault();
      if(!currentEmployee){ setMsg("Please select an employee.","error",true); return; }
      if(!currentWarrant){ setMsg("Please select a pay period.","error",true); return; }
      const entries=[]; [...document.querySelectorAll('#timeBody tr')].forEach(row=>{
        const date=row.querySelector('.date-cell')?.value||'';
        const start=row.querySelector('.time-start')?.value||'';
        const end=row.querySelector('.time-end')?.value||'';
        const hours=parseFloat(row.querySelector('.time-hours')?.value||0)||0;
        const type=row.querySelector('.time-type')?.value||'Regular';
        const gl=row.querySelector('.gl-input')?.value||'';
        const desc=row.children[6]?.querySelector('input')?.value||'';
        if(date && hours>0) entries.push({date,start,end,hours,type,gl,description:desc});
      });
      if(!entries.length){ setMsg("Add at least one time entry.","error",true); return; }
      const totals={
        totalHours: parseFloat(document.getElementById('totalHours')?.textContent||0),
        regularHours: parseFloat(document.getElementById('sumRegular')?.textContent||0),
        sickHours: parseFloat(document.getElementById('sumSick')?.textContent||0),
        personalHours: parseFloat(document.getElementById('sumPersonal')?.textContent||0),
        vacationHours: parseFloat(document.getElementById('sumVacation')?.textContent||0),
        holidayHours: parseFloat(document.getElementById('sumHoliday')?.textContent||0),
        grossPay: document.getElementById('grossPay')?.textContent||"$0.00"
      };
      const payload={
        meta:{submittedAt:new Date().toISOString(), notify:NOTIFY, source:"HubbTIME (HubbFISCAL)"},
        employee:{ name:currentEmployee.name, department:currentEmployee.department, payType:currentEmployee.payType, rate:currentEmployee.rate, position:currentEmployee.position||null },
        warrant: currentWarrant,
        entries, totals
      };
      const btn=document.getElementById('submitBtn'), status=document.getElementById('submitStatus');
      try{
        if(btn) btn.disabled=true; if(status) status.textContent='Sending to payroll…'; setMsg('Submitting timesheet…','info',true);
        const res=await fetch(FLOW_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!res.ok) throw new Error('Submission failed with status '+res.status);
        setMsg('Timesheet submitted successfully.','success',true); if(status) status.textContent='Submitted ✔';
      }catch(err){
        console.error(err); setMsg('Error submitting timesheet: '+err.message,'error',true);
        if(status) status.textContent='There was a problem submitting. Please try again.';
      }finally{ if(btn) btn.disabled=false; }
    }

    // ---------- Public API ----------
    api.addRow=addTimeRow; api.addRowWith=addTimeRowWith; api.recalc=calculateTotals; api.defaultGL=getDefaultGL;
    api.getCurrentEmployee=()=>currentEmployee; api.addTownHallHours=addTownHallHours; api.addSplitShift=addSplitShift;
    api.addOvertimeDay=addOvertimeDay; api.addSickDay=addSickDay; api.addVacationDay=addVacationDay; api.updateGLReview=updateGLReview;

    return api;
  })();
  </script>
</body>
</html>


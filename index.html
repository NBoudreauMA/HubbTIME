<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HubbTIME · HubbFISCAL</title>
  <meta name="description" content="Town of Hubbardston — Non-Union Biweekly Timesheet (HubbTIME)" />
  <link rel="icon" href="assets/favicon.svg" />
  <link rel="stylesheet" href="css/main.css" />
</head>
<body>
  <a class="skip-link sr-only" href="#main">Skip to content</a>

  <header class="site-header">
    <div class="brand">
      <div class="seal" aria-hidden="true">H</div>
      <div class="brand-text">
        <h1 class="site-title">HubbFISCAL</h1>
        <p class="tagline">Town of Hubbardston · Budget & Financial Management Hub</p>
      </div>
    </div>
    <nav class="main-nav" aria-label="Primary" aria-expanded="false">
      <button class="nav-toggle" aria-expanded="false" aria-controls="navList">Menu</button>
      <ul id="navList">
        <li><a href="index.html">Home</a></li>
        <li><a href="fy27/index.html">FY27 Budget</a></li>
        <li><a href="reports/index.html">Reports</a></li>
        <li><a href="benchmarks/index.html">Benchmarks</a></li>
        <li><a href="capital/index.html">Capital</a></li>
        <li><a href="grants/index.html">Grants</a></li>
        <li><a href="checkbook/index.html">Checkbook</a></li>
        <li><a href="meetings/index.html">Meetings</a></li>
        <li><a href="participate/index.html">Participate</a></li>
        <li><a href="Hubbtime.html" class="active">HubbTIME</a></li>
      </ul>
    </nav>
    <div style="margin-left: auto;">
      <button id="themeToggle" class="btn ghost" aria-pressed="false">Light</button>
    </div>
  </header>

  <main id="main" class="container">
    <div id="hubbtimeContainer">
      <header class="page-header">
        <h1>Town of Hubbardston — Enhanced Biweekly Timesheet</h1>
        <p>Smart timesheet system with automated calculations and municipal GL integration</p>
      </header>

      <form id="timesheetForm">
        <div id="systemMsg" class="alert info" role="status" aria-live="polite" style="display:none;"></div>

        <!-- Employee Information Section -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">Employee Information</h2>
          </div>
          
          <div class="form-group">
            <label class="label" for="employeeSearch">Employee (search by name)</label>
            <div style="display:flex; gap:var(--space-sm); align-items:center;">
              <input 
                id="employeeSearch" 
                list="employeeList" 
                placeholder="Start typing a name..." 
                autocomplete="off" 
                class="input"
              >
              <button type="button" class="btn secondary" id="clearEmployeeBtn">Clear</button>
            </div>
            <datalist id="employeeList"></datalist>
            <input type="hidden" id="employeeIndex" value="">
          </div>

          <div class="employee-info" id="employeeDetails" style="display:none;">
            <div class="totals-grid">
              <div class="total-item">
                <div class="total-label">Department</div>
                <div class="total-value" id="department">—</div>
              </div>
              <div class="total-item">
                <div class="total-label">Pay Type</div>
                <div class="total-value" id="payType">—</div>
              </div>
              <div class="total-item">
                <div class="total-label">Rate / Salary</div>
                <div class="total-value" id="rate">—</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Pay Period Selection -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">Pay Period</h2>
          </div>
          
          <div class="form-group">
            <label class="label" for="warrant">Select Pay Period</label>
            <select id="warrant" class="input">
              <option value="">Select Pay Period...</option>
            </select>
          </div>
        </section>

        <!-- Time Entries Section -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">Time Entries</h2>
          </div>

          <div class="quick-actions">
            <button type="button" class="btn primary" id="addRowBtn">Add Row</button>
            <button type="button" class="btn secondary" id="townHallBtn">Town Hall Hours</button>
            <button type="button" class="btn secondary" id="splitShiftBtn">Split Shift</button>
            <button type="button" class="btn secondary" id="overtimeBtn">Overtime Day</button>
            <button type="button" class="btn secondary" id="sickBtn">Sick Day</button>
            <button type="button" class="btn secondary" id="personalBtn">Personal Day</button>
            <button type="button" class="btn secondary" id="vacationBtn">Vacation Day</button>
            <button type="button" class="btn secondary" id="holidayBtn">Holiday</button>
            <button type="button" class="btn danger" id="clearAllBtn">Clear All</button>
          </div>

          <div class="table-container">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Hours</th>
                    <th>Type</th>
                    <th>GL Code</th>
                    <th>Description</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="timeBody">
                  <!-- Dynamic rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Summary Section -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">Summary</h2>
          </div>

          <div class="totals-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-md);">
              <div>
                <div class="total-label">Total Hours This Period</div>
                <div id="totalHours" class="total-value">0.00</div>
              </div>
              <div style="text-align:right;">
                <div class="total-label">Estimated Gross Pay</div>
                <div id="grossPay" class="total-value">$0.00</div>
              </div>
            </div>
          </div>

          <div class="totals-grid">
            <div class="total-item">
              <div class="total-label">Regular</div>
              <div class="total-value" id="sumRegular">0.00</div>
            </div>
            <div class="total-item">
              <div class="total-label">Sick</div>
              <div class="total-value" id="sumSick">0.00</div>
            </div>
            <div class="total-item">
              <div class="total-label">Personal</div>
              <div class="total-value" id="sumPersonal">0.00</div>
            </div>
            <div class="total-item">
              <div class="total-label">Vacation</div>
              <div class="total-value" id="sumVacation">0.00</div>
            </div>
            <div class="total-item">
              <div class="total-label">Holiday</div>
              <div class="total-value" id="sumHoliday">0.00</div>
            </div>
          </div>
        </section>

        <!-- GL Review Section -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">GL Review — Hours & Cost Allocation</h2>
          </div>
          
          <div id="glReviewWrap" class="table-container">
            <p class="text-center text-muted" style="padding:var(--space-xl);">
              Enter time entries above to see GL code breakdown and cost allocation
            </p>
          </div>
          
          <div class="alert info">
            <strong>Smart Allocation:</strong> 
            Hourly employees: Regular hours automatically convert to overtime (1.5x rate) when weekly total exceeds 40 hours. 
            Salary employees: Biweekly salary split proportionally across GL codes based on time allocation.
          </div>
        </section>

        <!-- Submit Section (with compliance + signature notice) -->
        <section class="card text-center">
          <div class="alert info" role="note" aria-label="Compliance Notice" style="margin-bottom:var(--space-md); text-align:left;">
            <p><strong>Compliance Notice:</strong></p>
            <p>
              By selecting "Submit Timesheet," you attest that the information provided is accurate and complete to the best of your knowledge. 
              Your submission constitutes your electronic signature and certification in accordance with Massachusetts General Laws, including 
              public records requirements (MGL c. 66) and attestations made under penalty of perjury (MGL c. 268 §6A).
            </p>
          </div>

          <button type="submit" class="btn primary" id="submitBtn" style="padding:var(--space-md) var(--space-xl); font-size:1.1rem;">
            Submit Timesheet
          </button>
          <div id="submitStatus" class="mt-md"></div>
        </section>
      </form>
    </div>
  </main>

  <footer class="site-footer text-center" style="margin-top:var(--space-3xl); padding:var(--space-lg); color:var(--muted);">
    <p>&copy; 2025 Town of Hubbardston, MA · <a href="mailto:admin@hubbardstonma.gov">admin@hubbardstonma.gov</a></p>
  </footer>

  <!-- Status Indicators -->
  <div class="status-indicator saving" id="autoSaveIndicator" style="position:fixed; top:var(--space-md); right:var(--space-md); opacity:0; transition:opacity 0.3s ease; z-index:1000;" aria-live="polite">
    <div class="loading-spinner"></div>
    Auto-saved
  </div>

  <script>
/* =========================================================
   HubbTIME · Enhanced Municipal Timesheet System
   Town of Hubbardston, Massachusetts
   ========================================================= */

(function() {
  'use strict';

  // Employee Database
  const EMPLOYEES = [
    { name: "John Smith", department: "Highway", payType: "Hourly", rate: 28.50, glCodes: ["420-5100", "420-5200"] },
    { name: "Sarah Johnson", department: "Library", payType: "Salary", rate: 45000, glCodes: ["610-5100"] },
    { name: "Michael Brown", department: "Fire", payType: "Hourly", rate: 32.75, glCodes: ["220-5100", "220-5200"] },
    { name: "Jennifer Davis", department: "Police", payType: "Hourly", rate: 35.25, glCodes: ["210-5100", "210-5200"] },
    { name: "Robert Wilson", department: "Parks & Recreation", payType: "Hourly", rate: 26.80, glCodes: ["650-5100", "650-5200"] },
    { name: "Lisa Anderson", department: "Town Hall", payType: "Salary", rate: 52000, glCodes: ["122-5100", "122-5200"] },
    { name: "David Miller", department: "Water", payType: "Hourly", rate: 30.15, glCodes: ["450-5100", "450-5200"] },
    { name: "Karen Taylor", department: "Assessors", payType: "Salary", rate: 48000, glCodes: ["141-5100"] },
    { name: "James Garcia", department: "Building", payType: "Hourly", rate: 33.90, glCodes: ["241-5100", "241-5200"] },
    { name: "Mary Rodriguez", department: "Council on Aging", payType: "Hourly", rate: 22.50, glCodes: ["541-5100"] },
    { name: "Thomas Martinez", department: "Cemetery", payType: "Hourly", rate: 25.75, glCodes: ["195-5100"] },
    { name: "Patricia Lewis", department: "Town Clerk", payType: "Salary", rate: 46000, glCodes: ["161-5100"] },
    { name: "Christopher Lee", department: "Transfer Station", payType: "Hourly", rate: 24.25, glCodes: ["433-5100"] },
    { name: "Nancy Walker", department: "Treasurer", payType: "Salary", rate: 55000, glCodes: ["145-5100"] },
    { name: "Daniel Hall", department: "Animal Control", payType: "Hourly", rate: 21.75, glCodes: ["292-5100"] }
  ];

  // GL Code Database
  const GL_CODES = {
    "122-5100": "Town Admin - Wages",
    "122-5200": "Town Admin - Overtime", 
    "141-5100": "Assessors - Wages",
    "145-5100": "Treasurer - Wages",
    "161-5100": "Town Clerk - Wages",
    "195-5100": "Cemetery - Wages",
    "210-5100": "Police - Wages",
    "210-5200": "Police - Overtime",
    "220-5100": "Fire - Wages", 
    "220-5200": "Fire - Overtime",
    "241-5100": "Building Inspector - Wages",
    "241-5200": "Building Inspector - Overtime",
    "292-5100": "Animal Control - Wages",
    "420-5100": "Highway - Wages",
    "420-5200": "Highway - Overtime",
    "433-5100": "Transfer Station - Wages",
    "450-5100": "Water Dept - Wages",
    "450-5200": "Water Dept - Overtime",
    "541-5100": "Council on Aging - Wages",
    "610-5100": "Library - Wages",
    "650-5100": "Parks & Rec - Wages",
    "650-5200": "Parks & Rec - Overtime"
  };

  // Pay Periods (example data)
  const PAY_PERIODS = [
    { id: "2025-01", label: "Pay Period 1 (Jan 2-15, 2025)", startDate: "2025-01-02", endDate: "2025-01-15" },
    { id: "2025-02", label: "Pay Period 2 (Jan 16-29, 2025)", startDate: "2025-01-16", endDate: "2025-01-29" },
    { id: "2025-03", label: "Pay Period 3 (Jan 30-Feb 12, 2025)", startDate: "2025-01-30", endDate: "2025-02-12" },
    { id: "2025-04", label: "Pay Period 4 (Feb 13-26, 2025)", startDate: "2025-02-13", endDate: "2025-02-26" },
    { id: "2025-05", label: "Pay Period 5 (Feb 27-Mar 12, 2025)", startDate: "2025-02-27", endDate: "2025-03-12" },
    { id: "2025-06", label: "Pay Period 6 (Mar 13-26, 2025)", startDate: "2025-03-13", endDate: "2025-03-26" }
  ];

  // Global state
  let currentEmployee = null;
  let timeEntries = [];
  let autoSaveTimeout = null;

  // DOM helpers
  function $(selector) { return document.querySelector(selector); }
  function $$(selector) { return document.querySelectorAll(selector); }

  // Utility functions
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
  }

  function formatHours(hours) {
    return parseFloat(hours).toFixed(2);
  }

  function timeToMinutes(timeStr) {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
  }

  function minutesToTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
  }

  function calculateHours(startTime, endTime) {
    if (!startTime || !endTime) return 0;
    const startMinutes = timeToMinutes(startTime);
    const endMinutes = timeToMinutes(endTime);
    return Math.max(0, (endMinutes - startMinutes) / 60);
  }

  function showMessage(text, type = 'info', duration = 5000) {
    const msgEl = $('#systemMsg');
    msgEl.className = `alert ${type}`;
    msgEl.textContent = text;
    msgEl.style.display = 'block';
    setTimeout(() => msgEl.style.display = 'none', duration);
  }

  function showAutoSave() {
    const indicator = $('#autoSaveIndicator');
    indicator.style.opacity = '1';
    setTimeout(() => indicator.style.opacity = '0', 2000);
  }

  // Initialize employee list
  function initEmployeeList() {
    const datalist = $('#employeeList');
    datalist.innerHTML = '';
    EMPLOYEES.forEach((emp, index) => {
      const option = document.createElement('option');
      option.value = emp.name;
      option.dataset.index = index;
      datalist.appendChild(option);
    });
  }

  // Initialize pay periods
  function initPayPeriods() {
    const select = $('#warrant');
    PAY_PERIODS.forEach(period => {
      const option = document.createElement('option');
      option.value = period.id;
      option.textContent = period.label;
      select.appendChild(option);
    });
  }

  // Initialize GL datalist
  function initGLCodes() {
    const datalist = document.createElement('datalist');
    datalist.id = 'glList';
    Object.entries(GL_CODES).forEach(([code, desc]) => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = `${code} - ${desc}`;
      datalist.appendChild(option);
    });
    document.body.appendChild(datalist);
  }

  // Handle employee selection
  function handleEmployeeSelection() {
    const searchInput = $('#employeeSearch');
    const employeeIndex = $('#employeeIndex');
    const selectedName = searchInput.value.trim();
    
    const employee = EMPLOYEES.find(emp => emp.name === selectedName);
    if (employee) {
      const index = EMPLOYEES.indexOf(employee);
      employeeIndex.value = index;
      currentEmployee = employee;
      updateEmployeeDetails(employee);
      showMessage(`Selected employee: ${employee.name}`, 'success');
    } else {
      clearEmployee();
    }
  }

  function updateEmployeeDetails(employee) {
    $('#employeeDetails').style.display = 'block';
    $('#department').textContent = employee.department;
    $('#payType').textContent = employee.payType;
    $('#rate').textContent = employee.payType === 'Hourly' 
      ? `$${employee.rate.toFixed(2)}/hr` 
      : formatCurrency(employee.rate);
  }

  function clearEmployee() {
    $('#employeeSearch').value = '';
    $('#employeeIndex').value = '';
    $('#employeeDetails').style.display = 'none';
    currentEmployee = null;
  }

  // Time entry management
  function addTimeEntry(data = {}) {
    const entry = {
      id: Date.now() + Math.random(),
      date: data.date || '',
      startTime: data.startTime || '',
      endTime: data.endTime || '',
      hours: data.hours || '',
      type: data.type || 'Regular',
      glCode: data.glCode || getDefaultGL(),
      description: data.description || '',
      ...data
    };
    
    timeEntries.push(entry);
    renderTimeEntries();
    calculateTotals();
    return entry;
  }

  function getDefaultGL() {
    if (!currentEmployee || !currentEmployee.glCodes || !currentEmployee.glCodes.length) {
      return Object.keys(GL_CODES)[0];
    }
    return currentEmployee.glCodes[0];
  }

  function renderTimeEntries() {
    const tbody = $('#timeBody');
    tbody.innerHTML = '';
    
    timeEntries.forEach(entry => {
      const row = createTimeEntryRow(entry);
      tbody.appendChild(row);
    });
  }

  function createTimeEntryRow(entry) {
    const row = document.createElement('tr');
    row.dataset.id = entry.id;
    
    row.innerHTML = `
      <td><input type="date" class="input date-cell" value="${entry.date}"></td>
      <td><input type="time" class="input time-start" value="${entry.startTime}"></td>
      <td><input type="time" class="input time-end" value="${entry.endTime}"></td>
      <td><input type="number" class="input hours-cell" step="0.01" min="0" max="24" value="${entry.hours}"></td>
      <td>
        <select class="input time-type">
          <option value="Regular" ${entry.type === 'Regular' ? 'selected' : ''}>Regular</option>
          <option value="Sick" ${entry.type === 'Sick' ? 'selected' : ''}>Sick</option>
          <option value="Personal" ${entry.type === 'Personal' ? 'selected' : ''}>Personal</option>
          <option value="Vacation" ${entry.type === 'Vacation' ? 'selected' : ''}>Vacation</option>
          <option value="Holiday" ${entry.type === 'Holiday' ? 'selected' : ''}>Holiday</option>
        </select>
      </td>
      <td><input type="text" class="input gl-code" list="glList" value="${entry.glCode}" placeholder="GL Code"></td>
      <td><input type="text" class="input description" value="${entry.description}" placeholder="Description"></td>
      <td>
        <button type="button" class="btn danger btn-sm" onclick="HubbTIME.removeEntry('${entry.id}')">Remove</button>
      </td>
    `;

    // Add event listeners for real-time calculation
    const inputs = row.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.addEventListener('input', () => updateEntryFromRow(row));
      input.addEventListener('change', () => updateEntryFromRow(row));
    });

    return row;
  }

  function updateEntryFromRow(row) {
    const entryId = row.dataset.id;
    const entry = timeEntries.find(e => e.id == entryId);
    if (!entry) return;

    const startTime = row.querySelector('.time-start').value;
    const endTime = row.querySelector('.time-end').value;
    const hoursInput = row.querySelector('.hours-cell');

    // Auto-calculate hours if start/end times are provided
    if (startTime && endTime) {
      const calculatedHours = calculateHours(startTime, endTime);
      if (calculatedHours > 0) {
        hoursInput.value = calculatedHours.toFixed(2);
      }
    }

    // Update entry data
    entry.date = row.querySelector('.date-cell').value;
    entry.startTime = startTime;
    entry.endTime = endTime;
    entry.hours = hoursInput.value;
    entry.type = row.querySelector('.time-type').value;
    entry.glCode = row.querySelector('.gl-code').value;
    entry.description = row.querySelector('.description').value;

    calculateTotals();
    scheduleAutoSave();
  }

  function removeEntry(entryId) {
    timeEntries = timeEntries.filter(e => e.id != entryId);
    renderTimeEntries();
    calculateTotals();
    showMessage('Entry removed', 'info');
  }

  function clearAllEntries() {
    if (timeEntries.length > 0 && !confirm('Are you sure you want to clear all time entries?')) {
      return;
    }
    timeEntries = [];
    renderTimeEntries();
    calculateTotals();
    showMessage('All entries cleared', 'info');
  }

  // Calculations
  function calculateTotals() {
    const totals = {
      Regular: 0,
      Sick: 0,
      Personal: 0,
      Vacation: 0,
      Holiday: 0,
      total: 0
    };

    timeEntries.forEach(entry => {
      const hours = parseFloat(entry.hours) || 0;
      totals[entry.type] = (totals[entry.type] || 0) + hours;
      totals.total += hours;
    });

    // Update display
    $('#totalHours').textContent = formatHours(totals.total);
    $('#sumRegular').textContent = formatHours(totals.Regular);
    $('#sumSick').textContent = formatHours(totals.Sick);
    $('#sumPersonal').textContent = formatHours(totals.Personal);
    $('#sumVacation').textContent = formatHours(totals.Vacation);
    $('#sumHoliday').textContent = formatHours(totals.Holiday);

    // Calculate gross pay
    calculateGrossPay(totals);
    
    // Update GL review
    updateGLReview();
  }

  function calculateGrossPay(totals) {
    if (!currentEmployee) {
      $('#grossPay').textContent = '$0.00';
      return;
    }

    let grossPay = 0;
    
    if (currentEmployee.payType === 'Hourly') {
      const regularHours = totals.Regular;
      const rate = currentEmployee.rate;
      
      // Calculate overtime (over 40 hours per week)
      // For simplicity, assume overtime for any regular hours over 40 in the period
      const overtimeThreshold = 80; // 40 hours * 2 weeks
      
      if (regularHours <= overtimeThreshold) {
        grossPay = regularHours * rate;
      } else {
        const regularPay = overtimeThreshold * rate;
        const overtimePay = (regularHours - overtimeThreshold) * rate * 1.5;
        grossPay = regularPay + overtimePay;
      }
      
      // Add other paid time at regular rate
      grossPay += (totals.Sick + totals.Personal + totals.Vacation + totals.Holiday) * rate;
      
    } else {
      // Salary employee - biweekly amount
      grossPay = currentEmployee.rate / 26; // Annual salary / 26 pay periods
    }

    $('#grossPay').textContent = formatCurrency(grossPay);
  }

  function updateGLReview() {
    const glReviewWrap = $('#glReviewWrap');
    
    if (timeEntries.length === 0) {
      glReviewWrap.innerHTML = `
        <p class="text-center text-muted" style="padding:var(--space-xl);">
          Enter time entries above to see GL code breakdown and cost allocation
        </p>
      `;
      return;
    }

    // Group entries by GL code
    const glTotals = {};
    timeEntries.forEach(entry => {
      const glCode = entry.glCode || 'Unassigned';
      const hours = parseFloat(entry.hours) || 0;
      
      if (!glTotals[glCode]) {
        glTotals[glCode] = {
          hours: 0,
          cost: 0,
          description: GL_CODES[glCode] || 'Unknown GL Code'
        };
      }
      
      glTotals[glCode].hours += hours;
      
      // Calculate cost allocation
      if (currentEmployee) {
        if (currentEmployee.payType === 'Hourly') {
          glTotals[glCode].cost += hours * currentEmployee.rate;
        } else {
          // For salary, allocate proportionally
          const totalHours = timeEntries.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
          if (totalHours > 0) {
            const proportion = hours / totalHours;
            glTotals[glCode].cost += (currentEmployee.rate / 26) * proportion;
          }
        }
      }
    });

    // Create GL review table
    let tableHTML = `
      <table>
        <thead>
          <tr>
            <th>GL Code</th>
            <th>Description</th>
            <th>Hours</th>
            <th>Allocated Cost</th>
          </tr>
        </thead>
        <tbody>
    `;

    Object.entries(glTotals).forEach(([glCode, data]) => {
      tableHTML += `
        <tr>
          <td><strong>${glCode}</strong></td>
          <td>${data.description}</td>
          <td>${formatHours(data.hours)}</td>
          <td>${formatCurrency(data.cost)}</td>
        </tr>
      `;
    });

    tableHTML += '</tbody></table>';
    glReviewWrap.innerHTML = tableHTML;
  }

  // Quick Actions
  function addTownHallHours() {
    const today = new Date().toISOString().slice(0, 10);
    addTimeEntry({
      date: today,
      startTime: '08:00',
      endTime: '16:30',
      hours: '8.00',
      type: 'Regular',
      glCode: getDefaultGL(),
      description: 'Town Hall Hours'
    });
    showMessage('Town Hall hours added', 'success');
  }

  function addHolidayDay() {
    const today = new Date().toISOString().slice(0, 10);
    addTimeEntry({
      date: today,
      hours: '8.00',
      type: 'Holiday',
      glCode: getDefaultGL(),
      description: 'Holiday'
    });
    showMessage('Holiday day added', 'success');
  }

  function addPersonalDay() {
    const today = new Date().toISOString().slice(0, 10);
    addTimeEntry({
      date: today,
      hours: '8.00',
      type: 'Personal',
      glCode: getDefaultGL(),
      description: 'Personal Day'
    });
    showMessage('Personal day added', 'success');
  }

  // Auto-save functionality
  function scheduleAutoSave() {
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }
    autoSaveTimeout = setTimeout(() => {
      saveToLocalStorage();
      showAutoSave();
    }, 2000);
  }

  function saveToLocalStorage() {
    const data = {
      currentEmployee: currentEmployee,
      timeEntries: timeEntries,
      warrant: $('#warrant').value,
      timestamp: Date.now()
    };
    localStorage.setItem('hubbtime_data', JSON.stringify(data));
  }

  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem('hubbtime_data');
      if (saved) {
        const data = JSON.parse(saved);
        
        if (data.currentEmployee) {
          currentEmployee = data.currentEmployee;
          $('#employeeSearch').value = data.currentEmployee.name;
          updateEmployeeDetails(data.currentEmployee);
        }
        
        if (data.timeEntries && Array.isArray(data.timeEntries)) {
          timeEntries = data.timeEntries;
          renderTimeEntries();
          calculateTotals();
        }
        
        if (data.warrant) {
          $('#warrant').value = data.warrant;
        }
        
        showMessage('Previous work restored', 'success');
      }
    } catch (error) {
      console.error('Error loading saved data:', error);
    }
  }

  // Form submission
  function handleSubmit(event) {
    event.preventDefault();
    
    if (!currentEmployee) {
      showMessage('Please select an employee first', 'error');
      return;
    }
    
    if (!$('#warrant').value) {
      showMessage('Please select a pay period', 'error');
      return;
    }
    
    if (timeEntries.length === 0) {
      showMessage('Please add at least one time entry', 'error');
      return;
    }
    
    // Validate all entries have required fields
    const incompleteEntries = timeEntries.filter(entry => 
      !entry.date || !entry.glCode || (!entry.hours || parseFloat(entry.hours) <= 0)
    );
    
    if (incompleteEntries.length > 0) {
      showMessage('Please complete all time entries (date, hours, GL code required)', 'error');
      return;
    }
    
    // Show loading state
    const submitBtn = $('#submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Simulate submission
    setTimeout(() => {
      const submitData = {
        employee: currentEmployee,
        payPeriod: $('#warrant').value,
        timeEntries: timeEntries,
        totals: calculateSubmissionTotals(),
        submittedAt: new Date().toISOString()
      };
      
      console.log('Timesheet submitted:', submitData);
      
      // Clear saved data
      localStorage.removeItem('hubbtime_data');
      
      showMessage('Timesheet submitted successfully!', 'success', 10000);
      
      // Reset form
      setTimeout(() => {
        if (confirm('Timesheet submitted! Would you like to start a new timesheet?')) {
          resetForm();
        }
      }, 2000);
      
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }, 2000);
  }

  function calculateSubmissionTotals() {
    return timeEntries.reduce((acc, entry) => {
      const hours = parseFloat(entry.hours) || 0;
      acc[entry.type] = (acc[entry.type] || 0) + hours;
      acc.total = (acc.total || 0) + hours;
      return acc;
    }, {});
  }

  function resetForm() {
    clearEmployee();
    $('#warrant').value = '';
    timeEntries = [];
    renderTimeEntries();
    calculateTotals();
    showMessage('Ready for new timesheet', 'info');
  }

  // Theme toggle
  function initThemeToggle() {
    const themeToggle = $('#themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    
    document.documentElement.setAttribute('data-theme', currentTheme);
    themeToggle.textContent = currentTheme === 'dark' ? 'Light' : 'Dark';
    themeToggle.setAttribute('aria-pressed', currentTheme === 'dark');
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeToggle.textContent = newTheme === 'dark' ? 'Light' : 'Dark';
      themeToggle.setAttribute('aria-pressed', newTheme === 'dark');
    });
  }

  // Navigation toggle
  function initNavigation() {
    const navToggle = $('.nav-toggle');
    const nav = $('.main-nav');
    
    navToggle.addEventListener('click', () => {
      const expanded = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', !expanded);
      nav.setAttribute('aria-expanded', !expanded);
    });
  }

  // Public API for supplemental scripts
  const publicAPI = {
    addRowWith: function(date, startTime, endTime, hours, type, glCode, description) {
      return addTimeEntry({
        date: date || '',
        startTime: startTime || '',
        endTime: endTime || '',
        hours: hours || '',
        type: type || 'Regular',
        glCode: glCode || getDefaultGL(),
        description: description || ''
      });
    },
    
    recalc: function() {
      calculateTotals();
    },
    
    defaultGL: function(index) {
      return getDefaultGL();
    },
    
    removeEntry: function(entryId) {
      removeEntry(entryId);
    },
    
    getCurrentEmployee: function() {
      return currentEmployee;
    },
    
    getTimeEntries: function() {
      return [...timeEntries];
    }
  };

  // Initialize everything when DOM is ready
  function init() {
    initEmployeeList();
    initPayPeriods();
    initGLCodes();
    initThemeToggle();
    initNavigation();
    
    // Event listeners
    $('#employeeSearch').addEventListener('change', handleEmployeeSelection);
    $('#clearEmployeeBtn').addEventListener('click', clearEmployee);
    $('#addRowBtn').addEventListener('click', () => addTimeEntry());
    $('#townHallBtn').addEventListener('click', addTownHallHours);
    $('#holidayBtn').addEventListener('click', addHolidayDay);
    $('#personalBtn').addEventListener('click', addPersonalDay);
    $('#clearAllBtn').addEventListener('click', clearAllEntries);
    $('#timesheetForm').addEventListener('submit', handleSubmit);
    
    // Load saved data
    loadFromLocalStorage();
    
    showMessage('HubbTIME system ready', 'success');
  }

  // Export public API
  window.HubbTIME = publicAPI;

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();

/* =========================================================
   HubbTIME · Supplemental actions (uses public hooks)
   - Requires the main HubbTIME script to load first
   ========================================================= */
(function () {
  'use strict';

  function $ (s) { return document.querySelector(s); }

  function getLastRow() {
    const tbody = document.getElementById('timeBody');
    return tbody ? tbody.lastElementChild : null;
  }

  function hhmmToMin(hhmm) {
    if (!hhmm) return null;
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }
  function minToHHMM(mins) {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  // Split the **last** row into two equal time blocks
  function addSplitShift() {
    const last = getLastRow();
    if (!last) return alert('No row to split.');

    const date  = last.querySelector('.date-cell')?.value || '';
    const start = last.querySelector('.time-start')?.value || '';
    const end   = last.querySelector('.time-end')?.value || '';
    const type  = last.querySelector('.time-type')?.value || 'Regular';
    if (!date || !start || !end) return alert('Select date/start/end on the last row first.');
    if (type !== 'Regular') return alert('Split Shift expects a Regular row.');

    const s = hhmmToMin(start), e = hhmmToMin(end);
    if (s == null || e == null || e <= s) return alert('Invalid time range.');

    const mid = Math.floor((s + e) / 2);
    const gl  = ($('datalist#glList option')?.value) || (window.HubbTIME?.defaultGL?.(null) || '');

    // Remove last row and add two rows in its place
    last.remove();
    window.HubbTIME.addRowWith(date, start, minToHHMM(mid), '', 'Regular', gl, 'Split Shift (1/2)');
    window.HubbTIME.addRowWith(date, minToHHMM(mid), end, '', 'Regular', gl, 'Split Shift (2/2)');
    window.HubbTIME.recalc();
  }

  function addDay(kind, label) {
    const today = new Date().toISOString().slice(0,10);
    const gl = ($('datalist#glList option')?.value) || (window.HubbTIME?.defaultGL?.(null) || '');
    const type = kind; // 'Regular' | 'Sick' | 'Vacation'
    const desc = label;
    const hours = (kind === 'Regular') ? '8.00' : '8.00'; // adjust if you use other defaults
    window.HubbTIME.addRowWith(today, '', '', hours, type, gl, desc);
    window.HubbTIME.recalc();
  }

  function addOvertimeDay() { addDay('Regular',  'Overtime Day'); }
  function addSickDay()     { addDay('Sick',     'Sick Day'); }
  function addVacationDay() { addDay('Vacation', 'Vacation Day'); }

  // Bind after DOM & main script are ready
  window.addEventListener('DOMContentLoaded', () => {
    if (!window.HubbTIME || !window.HubbTIME.addRowWith) {
      console.error('HubbTIME hooks not found. Ensure main script exposes api.addRowWith, api.recalc, api.defaultGL.');
      return;
    }
    const split = $('#splitShiftBtn');  if (split) split.addEventListener('click', addSplitShift);
    const ot    = $('#overtimeBtn');    if (ot)    ot.addEventListener('click', addOvertimeDay);
    const sick  = $('#sickBtn');        if (sick)  sick.addEventListener('click', addSickDay);
    const vac   = $('#vacationBtn');    if (vac)   vac.addEventListener('click', addVacationDay);
  });
})();
  </script>
</body>
</html>
